AWSTemplateFormatVersion: '2010-09-09'
Description: 'CloudFormation template for Redis ElastiCache setup for Chatwoot'

Parameters:
  SumoChatwootVPCId:
    Description: 'VPC ID where the RDS instance will be deployed'
    Type: 'AWS::EC2::VPC::Id'

  SumoChatwootPrivateSubnet1Id:
    Description: 'Private Subnet 1 ID'
    Type: 'AWS::EC2::Subnet::Id'

  SumoChatwootPrivateSubnet2Id:
    Description: 'Private Subnet 2 ID'
    Type: 'AWS::EC2::Subnet::Id'

  SumoChatwootLoadBalancerSGId:
    Description: 'SumoChatwootLoadBalancerSG ID'
    Type: 'AWS::EC2::SecurityGroup::Id'

Resources:
  # Security Group for Redis
  SumoChatwootRedisSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      VpcId: !Ref SumoChatwootVPCId
      GroupDescription: Security group for Chatwoot Redis
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 6379
          ToPort: 6379
          SourceSecurityGroupId: !Ref SumoChatwootLoadBalancerSGId
      Tags:
        - Key: Name
          Value: sumo-chatwoot-redis-sg

  # ElastiCache Subnet Group
  SumoChatwootRedisSubnetGroup:
    Type: AWS::ElastiCache::SubnetGroup
    Properties:
      Description: Subnet group for Chatwoot Redis
      SubnetIds:
        - !Ref SumoChatwootPrivateSubnet1Id
        - !Ref SumoChatwootPrivateSubnet2Id
      Tags:
        - Key: Name
          Value: sumo-chatwoot-redis-group

  # Redis Cluster
  SumoChatwootRedisCluster:
    Type: AWS::ElastiCache::ReplicationGroup
    Properties:
      ReplicationGroupDescription: Chatwoot Redis cluster
      ReplicationGroupId: sumo-chatwoot-redis
      Engine: redis
      CacheNodeType: cache.t3.micro
      NumCacheClusters: 2
      AutomaticFailoverEnabled: true
      SecurityGroupIds:
        - !Ref SumoChatwootRedisSecurityGroup
      CacheSubnetGroupName: !Ref SumoChatwootRedisSubnetGroup
      Tags:
        - Key: Name
          Value: sumo-chatwoot-redis

Outputs:
  SumoChatwootRedisPrimaryEndpointAddress:
    Description: 'Primary endpoint address for the Redis cluster'
    Value: !GetAtt SumoChatwootRedisCluster.PrimaryEndPoint.Address

  SumoChatwootRedisPrimaryEndpointPort:
    Description: 'Primary endpoint port for the Redis cluster'
    Value: !GetAtt SumoChatwootRedisCluster.PrimaryEndPoint.Port
